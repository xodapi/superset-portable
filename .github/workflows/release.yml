name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Release
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      - name: Build Rust Launcher
        run: cargo build --release --bin superset-launcher

      - name: Build Rust Dashboard Tool
        run: cargo build --release --bin create_dashboard



      - name: Create Release Package
        run: |
          # We need to simulate the Python environment for build_release.py to work
          # or assume build_release.py handles missing embedded python gracefully 
          # by downloading it if we add that logic, OR we just use the system python 
          # to run the script, but the script expects 'python/' dir to exist.
          
          # Let's run the download script first to get the embedded python
          powershell ./setup/download_python.ps1
          
          # Install Superset in the embedded python
          $env:PYTHONHOME = "${{ github.workspace }}\python"
          $env:PATH = "${{ github.workspace }}\python;${{ github.workspace }}\python\Scripts;$env:PATH"
          
          python -m pip install --upgrade pip setuptools wheel
          # Attempt binary install first to avoid compilation issues
          python -m pip install apache-superset
          
          # Initialize Superset (creates superset.db)
          $env:SUPERSET_HOME = "${{ github.workspace }}\superset_home"
          mkdir $env:SUPERSET_HOME
          
          # Create config
          echo "import os" > "$env:SUPERSET_HOME\superset_config.py"
          echo "SECRET_KEY = 'portable-superset-secret-key-change-me'" >> "$env:SUPERSET_HOME\superset_config.py"
          echo "SQLALCHEMY_DATABASE_URI = 'sqlite:///' + os.path.join(os.path.dirname(__file__), 'superset.db')" >> "$env:SUPERSET_HOME\superset_config.py"
          
          # DB Upgrade & Init
          $env:SUPERSET_CONFIG_PATH = "$env:SUPERSET_HOME\superset_config.py"
          python -m superset db upgrade
          python -m superset fab create-admin --username admin --password admin --firstname Admin --lastname User --email admin@localhost
          python -m superset init
          
          # Now run the dashboard creator to populate the DB
          .\target\release\create_dashboard.exe

          # Now run the build script
          python build_release.py

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release/*.zip
          body_path: RELEASE_NOTES.md
          generate_release_notes: true
